var timetable = {
    "1A": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "2A": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "3A": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "4A": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "5A": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "1B": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "2B": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "3B": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "4B": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    },
    "5B": {
        "BS":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "3":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "4":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "5":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS1":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        },
        "AS2":{
            "teacher": "",
            "room": "",
            "subjectCode": "",
            "subjectName": "",
            "startDate": "",
            "endDate": ""
        }
    }
};

function readFile() {
    // Function to snatch the file off the file input HTML element and process it and plonk it within this code
    const icalFile = document.getElementById("icalFileReader").files[0];

    return new Promise((resolve, reject) => {
		const fileReader = new FileReader();
        // Optimising the file reader with check if the file can be read, or errors are faced.
		fileReader.onloadend = function(e) {
			var data;

            // Try and Catch to see if the file is parsable by ical.js in the first place.

			try {
				data = ICAL.parse(e.target.result); // Parsing through the file (within variable "e") 
			} catch(err) {
				alert("The file that you uploaded is invalid.\n Try again with a different iCal file."); // If error occurs thru ical parsing alert the end user.
			}

			resolve(data); // If reading is successful resolve the code through the promise to return in this function.
		};
		fileReader.onerror = function(e) {
			reject(e); // On a file reader error send a reject code output to the console for it handle.
		}


		fileReader.readAsText(icalFile); // Finally calling the file reader function and parsing in the ical file.
	});

}

function convertSentralDateToJSDate(events){
    // We take in the event[i].getFirstPropertyValue('FOO') and we individually pluck data and wham it inside an initialised date and return it for future processing
    var date = new Date();
    date.setUTCDate(events._time.day);
    date.setUTCMonth(events._time.month-1);
    date.setUTCFullYear(events._time.year);
    date.setUTCHours(events._time.hour);
    date.setUTCMinutes(events._time.minute);
    date.setUTCSeconds(events._time.second);
    date.setUTCMilliseconds(0);
    return date;
}

function capitalize(word) {
    const lower = word.toLowerCase();
    return word.charAt(0).toUpperCase() + lower.slice(1);
  }
  


async function icalProcess() {

    // Taking the parsed data from the readFile function into this main function, also waiting for it to end before moving on.
    var icalData = await readFile();

    // Turning all the raw ical text data into something a computer can read for future processing and storing the data into events
    var jcalDataComp = new ICAL.Component(icalData);
	var events = jcalDataComp.getAllSubcomponents("vevent");

    var firstDay = convertSentralDateToJSDate(events[0].getFirstPropertyValue('dtstart')).getDay();
    if(firstDay === 1) firstDay = 5;
    else firstDay--;
    console.log(firstDay);
    var passedFirstDay = 0;

    for(var i = 0; i < events.length; i++) {
        var week = "A";
        // Plucking raw data from the iCal abomination into readable individual variables
        var teacher = events[i].getFirstPropertyValue('description').split("\n")[0].split(": ")[1];
        // Formating the teacher name because Mr looks like MR on sentral's idiotic formatting
        if(teacher.startsWith("M") || teacher.startsWith("D")){ // If it starts with M for Ms or D for Dr, if theres any new titles add a or statement with the first letter of the title
            var titleName = capitalize(teacher.split(" ")[0]);
            var firstName = teacher.split(" ")[1];
            var lastName = teacher.split(" ")[2];
            teacher = `${titleName} ${firstName} ${lastName}`;
        }
        // Plucking raw data continued from the iCal abomination into readable individual variables
        var period = events[i].getFirstPropertyValue('description').split("\n")[1].split(": ")[1];
        var subjectCode = events[i].getFirstPropertyValue('summary').split(": ")[0];
        var subjectName = events[i].getFirstPropertyValue('summary').split(": ")[1].split(" Yr")[0];
        var room = events[i].getFirstPropertyValue('location').split(": ")[1];
        var startDate = convertSentralDateToJSDate(events[i].getFirstPropertyValue('dtstart'));
        var endDate = convertSentralDateToJSDate(events[i].getFirstPropertyValue('dtend'));
        var day = startDate.getDay();
        console.log("day");
        // Check if we have passed the week twice or once
        if(day === firstDay && period === "5") passedFirstDay++;
        if(passedFirstDay === 2){
            week = "B"
        } // If we pass the all the days once we change the week from A to B or vice versa
        if(passedFirstDay === 3) i = events.length + 69; // If we pass all the days again
        else{
            var day = startDate.getDay()+week;
            // Setting the Object "timetable" data from the readed data above
            timetable[`${day}`][period].teacher = teacher;
            timetable[`${day}`][period].subjectCode = subjectCode;
            timetable[`${day}`][period].subjectName = subjectName;
            timetable[`${day}`][period].room = room;
            timetable[`${day}`][period].startDate= startDate;
            timetable[`${day}`][period].endDate = endDate;
        }
    }

    console.log(timetable);
}
